const pool=require("../db"),bcrypt=require("bcrypt"),jwt=require("jsonwebtoken"),register=async(req,res)=>{const{nombre_completo:nombre_completo,email:email,password:password,especialidad:especialidad}=req.body;if(!nombre_completo||!email||!password)return res.status(400).json({error:"Nombre completo, email y contraseña son obligatorios."});try{const saltRounds=10,password_hash=await bcrypt.hash(password,saltRounds),insertQuery="\n      INSERT INTO Profesionales (nombre_completo, email, password_hash, especialidad)\n      VALUES ($1, $2, $3, $4)\n      RETURNING id, email, fecha_creacion;\n    ",newUser=await pool.query(insertQuery,[nombre_completo,email,password_hash,especialidad]);console.log("✅ Profesional registrado exitosamente:",newUser.rows[0]),res.status(201).json({message:"Profesional registrado exitosamente.",user:newUser.rows[0]})}catch(err){if("23505"===err.code)return res.status(409).json({error:"El correo electrónico ya está en uso."});console.error("❌ Error al registrar al profesional:",err),res.status(500).json({error:"Error interno del servidor."})}},login=async(req,res)=>{const{email:email,password:password}=req.body;if(!email||!password)return res.status(400).json({error:"Email y contraseña son obligatorios."});try{const findUserQuery="SELECT * FROM Profesionales WHERE email = $1",result=await pool.query(findUserQuery,[email]);if(0===result.rows.length)return res.status(401).json({error:"Credenciales inválidas."});const professional=result.rows[0],isMatch=await bcrypt.compare(password,professional.password_hash);if(!isMatch)return res.status(401).json({error:"Credenciales inválidas."});const payload={user:{id:professional.id,email:professional.email,nombre:professional.nombre_completo,especialidad:professional.especialidad}},token=jwt.sign(payload,process.env.JWT_SECRET,{expiresIn:"12h"});res.status(200).json({message:"Login exitoso.",token:token})}catch(err){console.error("❌ Error en el login:",err),res.status(500).json({error:"Error interno del servidor."})}};module.exports={register:register,login:login};